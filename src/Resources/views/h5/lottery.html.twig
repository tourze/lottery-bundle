{% extends '@Lottery/h5/base.html.twig' %}

{% block title %}{{ activity.title }} - æŠ½å¥–æ´»åŠ¨{% endblock %}

{% block extra_styles %}
/* æ´»åŠ¨å¤´éƒ¨æ ·å¼ */
.activity-header {
    text-align: center;
    margin-bottom: 20px;
}

.activity-banner {
    width: 100%;
    max-height: 200px;
    object-fit: cover;
    border-radius: 15px;
    margin-bottom: 15px;
}

.activity-title {
    font-size: 24px;
    font-weight: bold;
    color: #2c3e50;
    margin-bottom: 10px;
}

.activity-time {
    font-size: 14px;
    color: #7f8c8d;
    background: rgba(255, 255, 255, 0.7);
    padding: 8px 16px;
    border-radius: 20px;
    display: inline-block;
}

/* ç”¨æˆ·ä¿¡æ¯åŒºåŸŸ */
.user-info {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 15px;
    background: linear-gradient(45deg, #4ecdc4, #44a08d);
    color: white;
    border-radius: 15px;
    margin-bottom: 20px;
}

.user-info .chances {
    font-size: 16px;
    font-weight: bold;
}

.user-info .chances .number {
    font-size: 24px;
    color: #fff200;
}

/* å¥–å“å±•ç¤ºåŒºåŸŸ */
.prizes-section {
    margin-bottom: 30px;
}

.prizes-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: 15px;
    margin-top: 15px;
}

.prize-item {
    background: white;
    padding: 15px;
    border-radius: 12px;
    text-align: center;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    transition: transform 0.3s ease;
}

.prize-item:hover {
    transform: translateY(-2px);
}

.prize-image {
    width: 60px;
    height: 60px;
    object-fit: cover;
    border-radius: 50%;
    margin-bottom: 10px;
}

.prize-name {
    font-size: 14px;
    font-weight: 600;
    color: #2c3e50;
    margin-bottom: 5px;
}

.prize-desc {
    font-size: 12px;
    color: #7f8c8d;
}

/* æŠ½å¥–è½¬ç›˜æ ·å¼ */
.lottery-wheel {
    position: relative;
    width: 300px;
    height: 300px;
    margin: 20px auto;
}

.wheel-container {
    position: relative;
    width: 100%;
    height: 100%;
}

.wheel {
    width: 100%;
    height: 100%;
    border-radius: 50%;
    position: relative;
    overflow: hidden;
    box-shadow: 0 0 20px rgba(0,0,0,0.3);
    transition: transform 3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
}

.wheel-sector {
    position: absolute;
    width: 50%;
    height: 50%;
    transform-origin: right bottom;
    display: flex;
    align-items: flex-start;
    justify-content: center;
    padding-top: 20px;
    font-size: 12px;
    font-weight: bold;
    color: white;
    text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
}

.wheel-pointer {
    position: absolute;
    top: -10px;
    left: 50%;
    transform: translateX(-50%);
    width: 0;
    height: 0;
    border-left: 15px solid transparent;
    border-right: 15px solid transparent;
    border-top: 30px solid #ff4757;
    z-index: 10;
    filter: drop-shadow(0 2px 4px rgba(0,0,0,0.3));
}

.wheel-center {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 60px;
    height: 60px;
    background: linear-gradient(45deg, #ff6b6b, #ff8e53);
    border-radius: 50%;
    z-index: 5;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-weight: bold;
    font-size: 12px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.2);
}

/* æŠ½å¥–æŒ‰é’® */
.lottery-button {
    width: 200px;
    height: 60px;
    font-size: 18px;
    margin: 20px auto;
    display: block;
    position: relative;
    overflow: hidden;
}

.lottery-button:before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent);
    transition: left 0.5s;
}

.lottery-button:hover:before {
    left: 100%;
}

/* æ“ä½œæŒ‰é’®ç»„ */
.action-buttons {
    display: flex;
    gap: 10px;
    margin-top: 20px;
}

.action-buttons .btn {
    flex: 1;
    padding: 12px;
    font-size: 14px;
}

/* ä¸­å¥–ç»“æœå¼¹çª— */
.result-modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0,0,0,0.7);
    z-index: 1000;
    align-items: center;
    justify-content: center;
}

.result-modal.show {
    display: flex;
}

.result-content {
    background: white;
    padding: 30px;
    border-radius: 20px;
    text-align: center;
    max-width: 320px;
    margin: 20px;
    animation: modalIn 0.3s ease-out;
}

@keyframes modalIn {
    from { transform: scale(0.7); opacity: 0; }
    to { transform: scale(1); opacity: 1; }
}

.result-prize-image {
    width: 80px;
    height: 80px;
    object-fit: cover;
    border-radius: 50%;
    margin-bottom: 15px;
}

.result-title {
    font-size: 20px;
    font-weight: bold;
    color: #e74c3c;
    margin-bottom: 10px;
}

.result-prize-name {
    font-size: 16px;
    color: #2c3e50;
    margin-bottom: 15px;
}

.result-buttons {
    display: flex;
    gap: 10px;
    margin-top: 20px;
}

.result-buttons .btn {
    flex: 1;
    padding: 10px;
    font-size: 14px;
}
{% endblock %}

{% block content %}
<div class="fade-in">
    <!-- æ´»åŠ¨å¤´éƒ¨ -->
    <div class="activity-header">
        {% if activity.headPhoto %}
        <img src="{{ activity.headPhoto }}" alt="{{ activity.title }}" class="activity-banner">
        {% endif %}
        <h1 class="activity-title">{{ activity.title }}</h1>
        <div class="activity-time">
            æ´»åŠ¨æ—¶é—´ï¼š{{ activity.startTime|date('m-d H:i') }} è‡³ {{ activity.endTime|date('m-d H:i') }}
        </div>
    </div>

    <!-- ç”¨æˆ·ä¿¡æ¯ -->
    <div class="user-info">
        <div>
            <div>å‰©ä½™æŠ½å¥–æ¬¡æ•°</div>
            <div class="chances">
                <span class="number" id="userChances">-</span> æ¬¡
            </div>
        </div>
        <div>
            <button class="btn btn-secondary" onclick="showRecords()">æˆ‘çš„è®°å½•</button>
        </div>
    </div>

    <!-- å¥–å“å±•ç¤º -->
    <div class="card prizes-section">
        <h3 class="text-center mb-3">ğŸ ä¸°åšå¥–å“ç­‰ä½ æ¥æ‹¿</h3>
        <div class="prizes-grid" id="prizesGrid">
            <!-- å¥–å“åˆ—è¡¨å°†é€šè¿‡JavaScriptåŠ¨æ€åŠ è½½ -->
        </div>
    </div>

    <!-- æŠ½å¥–è½¬ç›˜ -->
    <div class="card text-center">
        <h3 class="mb-3">ğŸ¯ ç«‹å³æŠ½å¥–</h3>
        <div class="lottery-wheel">
            <div class="wheel-pointer"></div>
            <div class="wheel-container">
                <div class="wheel" id="lotteryWheel">
                    <!-- è½¬ç›˜æ‰‡å½¢å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
                </div>
                <div class="wheel-center">å¼€å§‹</div>
            </div>
        </div>
        
        <button class="btn btn-primary lottery-button" id="lotteryBtn" onclick="startLottery()">
            <span id="btnText">ç«‹å³æŠ½å¥–</span>
            <span id="btnLoading" class="loading" style="display: none;"></span>
        </button>
        
        <div class="action-buttons">
            <a href="{{ path('h5_lottery_rules', {activity_id: activity.id}) }}" class="btn btn-secondary">æ´»åŠ¨è§„åˆ™</a>
            <button class="btn btn-secondary" onclick="showRecords()">ä¸­å¥–è®°å½•</button>
        </div>
    </div>
</div>

<!-- ä¸­å¥–ç»“æœå¼¹çª— -->
<div class="result-modal" id="resultModal">
    <div class="result-content">
        <div id="resultContent">
            <!-- ç»“æœå†…å®¹å°†é€šè¿‡JavaScriptåŠ¨æ€å¡«å…… -->
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
// é¡µé¢æ•°æ®
const activityId = {{ activity.id }};
let userChances = 0;
let prizes = [];
let isLotteryRunning = false;

// é¡µé¢åˆå§‹åŒ–
document.addEventListener('DOMContentLoaded', function() {
    loadUserChances();
    loadPrizes();
});

// åŠ è½½ç”¨æˆ·æŠ½å¥–æ¬¡æ•°
async function loadUserChances() {
    try {
        const response = await fetch('/json-rpc', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                jsonrpc: '2.0',
                method: 'GetUserValidLotteryChanceCounts',
                params: {
                    activityId: activityId.toString()
                },
                id: 1
            })
        });
        
        const data = await response.json();
        if (data.result) {
            userChances = data.result.count || 0;
            document.getElementById('userChances').textContent = userChances;
            
            // æ›´æ–°æŠ½å¥–æŒ‰é’®çŠ¶æ€
            updateLotteryButton();
        }
    } catch (error) {
        console.error('åŠ è½½ç”¨æˆ·æŠ½å¥–æ¬¡æ•°å¤±è´¥:', error);
        LotteryUtils.showToast('è·å–æŠ½å¥–æ¬¡æ•°å¤±è´¥', 'error');
    }
}

// åŠ è½½å¥–å“åˆ—è¡¨
async function loadPrizes() {
    try {
        const response = await fetch('/json-rpc', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                jsonrpc: '2.0',
                method: 'GetLotteryPrizeList',
                params: {
                    activityId: activityId.toString()
                },
                id: 2
            })
        });
        
        const data = await response.json();
        if (data.result && data.result.prizes) {
            prizes = data.result.prizes;
            renderPrizes();
            renderWheel();
        }
    } catch (error) {
        console.error('åŠ è½½å¥–å“åˆ—è¡¨å¤±è´¥:', error);
        LotteryUtils.showToast('è·å–å¥–å“åˆ—è¡¨å¤±è´¥', 'error');
    }
}

// æ¸²æŸ“å¥–å“åˆ—è¡¨
function renderPrizes() {
    const grid = document.getElementById('prizesGrid');
    grid.innerHTML = '';
    
    prizes.forEach(prize => {
        const item = document.createElement('div');
        item.className = 'prize-item';
        item.innerHTML = `
            ${prize.picture ? `<img src="${prize.picture}" alt="${prize.name}" class="prize-image">` : '<div class="prize-image" style="background: #f8f9fa; display: flex; align-items: center; justify-content: center; font-size: 20px;">ğŸ</div>'}
            <div class="prize-name">${prize.name}</div>
            <div class="prize-desc">${prize.content || ''}</div>
        `;
        grid.appendChild(item);
    });
}

// æ¸²æŸ“è½¬ç›˜
function renderWheel() {
    const wheel = document.getElementById('lotteryWheel');
    wheel.innerHTML = '';
    
    const colors = ['#FF6B6B', '#4ECDC4', '#45B7D1', '#96CEB4', '#FECA57', '#FF9FF3', '#54A0FF', '#5F27CD'];
    const sectorAngle = 360 / prizes.length;
    
    prizes.forEach((prize, index) => {
        const sector = document.createElement('div');
        sector.className = 'wheel-sector';
        sector.style.background = colors[index % colors.length];
        sector.style.transform = `rotate(${index * sectorAngle}deg)`;
        sector.style.clipPath = `polygon(0% 100%, 0% 0%, ${Math.tan((sectorAngle * Math.PI) / 360) * 100}% 100%)`;
        sector.textContent = prize.name;
        wheel.appendChild(sector);
    });
}

// æ›´æ–°æŠ½å¥–æŒ‰é’®çŠ¶æ€
function updateLotteryButton() {
    const btn = document.getElementById('lotteryBtn');
    const btnText = document.getElementById('btnText');
    
    if (userChances <= 0) {
        btn.disabled = true;
        btn.className = 'btn btn-disabled lottery-button';
        btnText.textContent = 'æš‚æ— æŠ½å¥–æ¬¡æ•°';
    } else {
        btn.disabled = false;
        btn.className = 'btn btn-primary lottery-button';
        btnText.textContent = 'ç«‹å³æŠ½å¥–';
    }
}

// å¼€å§‹æŠ½å¥–
async function startLottery() {
    if (isLotteryRunning || userChances <= 0) {
        return;
    }
    
    isLotteryRunning = true;
    const btn = document.getElementById('lotteryBtn');
    const btnText = document.getElementById('btnText');
    const btnLoading = document.getElementById('btnLoading');
    
    // æ›´æ–°æŒ‰é’®çŠ¶æ€
    btn.disabled = true;
    btnText.style.display = 'none';
    btnLoading.style.display = 'inline-block';
    
    try {
        // è°ƒç”¨æŠ½å¥–æ¥å£
        const response = await fetch('/json-rpc', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                jsonrpc: '2.0',
                method: 'JoinLottery',
                params: {
                    activityId: activityId.toString()
                },
                id: 3
            })
        });
        
        const data = await response.json();
        
        if (data.result) {
            // æŠ½å¥–æˆåŠŸï¼Œå¼€å§‹è½¬ç›˜åŠ¨ç”»
            const prize = data.result.prize;
            const prizeIndex = prizes.findIndex(p => p.id === prize.id);
            
            if (prizeIndex !== -1) {
                // è®¡ç®—è½¬ç›˜è§’åº¦
                const sectorAngle = 360 / prizes.length;
                const targetAngle = 360 * 5 + (prizeIndex * sectorAngle) + (sectorAngle / 2); // è½¬5åœˆååœåœ¨ç›®æ ‡ä½ç½®
                
                // æ‰§è¡Œè½¬ç›˜åŠ¨ç”»
                const wheel = document.getElementById('lotteryWheel');
                wheel.style.transform = `rotate(${targetAngle}deg)`;
                
                // åŠ¨ç”»å®Œæˆåæ˜¾ç¤ºç»“æœ
                setTimeout(() => {
                    showResult(data.result);
                    userChances--;
                    document.getElementById('userChances').textContent = userChances;
                    updateLotteryButton();
                    isLotteryRunning = false;
                }, 3000);
            } else {
                // æ‰¾ä¸åˆ°å¯¹åº”å¥–å“
                LotteryUtils.showToast('æŠ½å¥–ç»“æœå¼‚å¸¸', 'error');
                isLotteryRunning = false;
            }
        } else {
            // æŠ½å¥–å¤±è´¥
            LotteryUtils.showToast(data.error?.message || 'æŠ½å¥–å¤±è´¥', 'error');
            isLotteryRunning = false;
        }
    } catch (error) {
        console.error('æŠ½å¥–è¯·æ±‚å¤±è´¥:', error);
        LotteryUtils.showToast('æŠ½å¥–è¯·æ±‚å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•', 'error');
        isLotteryRunning = false;
    } finally {
        // æ¢å¤æŒ‰é’®çŠ¶æ€
        btnText.style.display = 'inline-block';
        btnLoading.style.display = 'none';
        btn.disabled = false;
    }
}

// æ˜¾ç¤ºæŠ½å¥–ç»“æœ
function showResult(result) {
    const modal = document.getElementById('resultModal');
    const content = document.getElementById('resultContent');
    
    const prize = result.prize;
    const isWin = prize && prize.name !== 'è°¢è°¢å‚ä¸' && prize.name !== 'å®‰æ…°å¥–';
    
    content.innerHTML = `
        <div class="result-title">${isWin ? 'ğŸ‰ æ­å–œä¸­å¥–ï¼' : 'ğŸ˜Š å†æ¥å†å‰'}</div>
        ${prize.picture ? `<img src="${prize.picture}" alt="${prize.name}" class="result-prize-image">` : '<div class="result-prize-image" style="background: #f8f9fa; display: flex; align-items: center; justify-content: center; font-size: 40px;">ğŸ</div>'}
        <div class="result-prize-name">${prize.name}</div>
        ${prize.content ? `<div class="text-muted">${prize.content}</div>` : ''}
        <div class="result-buttons">
            ${isWin && prize.needConsignee ? `<button class="btn btn-primary" onclick="fillAddress('${result.chanceId}')">å¡«å†™åœ°å€</button>` : ''}
            <button class="btn btn-secondary" onclick="closeResult()">ç»§ç»­æŠ½å¥–</button>
        </div>
    `;
    
    modal.classList.add('show');
}

// å…³é—­ç»“æœå¼¹çª—
function closeResult() {
    document.getElementById('resultModal').classList.remove('show');
}

// å¡«å†™æ”¶è´§åœ°å€
function fillAddress(chanceId) {
    window.location.href = `{{ path('h5_lottery_address') }}?chance_id=${chanceId}`;
}

// æŸ¥çœ‹ä¸­å¥–è®°å½•
function showRecords() {
    window.location.href = `{{ path('h5_lottery_records') }}?activity_id=${activityId}`;
}

// ç‚¹å‡»å¼¹çª—å¤–éƒ¨å…³é—­
document.getElementById('resultModal').addEventListener('click', function(e) {
    if (e.target === this) {
        closeResult();
    }
});
{% endblock %} 