{% extends '@Lottery/h5/base.html.twig' %}

{% block title %}ä¸­å¥–è®°å½• - æŠ½å¥–æ´»åŠ¨{% endblock %}

{% block extra_styles %}
.back-button {
    position: absolute;
    top: 20px;
    left: 20px;
    width: 40px;
    height: 40px;
    background: rgba(255, 255, 255, 0.9);
    border: none;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 18px;
    color: #2c3e50;
    cursor: pointer;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    z-index: 10;
}

.back-button:hover {
    background: white;
    transform: translateY(-1px);
}

.record-item {
    background: white;
    border-radius: 12px;
    padding: 15px;
    margin-bottom: 15px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    display: flex;
    align-items: center;
    gap: 15px;
}

.record-prize-image {
    width: 60px;
    height: 60px;
    object-fit: cover;
    border-radius: 50%;
    flex-shrink: 0;
}

.record-info {
    flex: 1;
}

.record-prize-name {
    font-size: 16px;
    font-weight: 600;
    color: #2c3e50;
    margin-bottom: 5px;
}

.record-time {
    font-size: 12px;
    color: #7f8c8d;
    margin-bottom: 5px;
}

.record-status {
    font-size: 12px;
    padding: 4px 8px;
    border-radius: 12px;
    display: inline-block;
}

.status-winning {
    background: #fff3cd;
    color: #856404;
}

.status-sent {
    background: #d4edda;
    color: #155724;
}

.status-reviewed {
    background: #cce7ff;
    color: #004085;
}

.status-expired {
    background: #f8d7da;
    color: #721c24;
}

.empty-state {
    text-align: center;
    padding: 60px 20px;
    color: #7f8c8d;
}

.empty-icon {
    font-size: 64px;
    margin-bottom: 20px;
    opacity: 0.5;
}

.empty-title {
    font-size: 18px;
    margin-bottom: 10px;
}

.empty-desc {
    font-size: 14px;
    margin-bottom: 30px;
}

.loading-state {
    text-align: center;
    padding: 40px;
    display: none;
}

.loading-spinner {
    width: 40px;
    height: 40px;
    border: 4px solid #f3f3f3;
    border-top: 4px solid #FF6B6B;
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin: 0 auto 20px;
}

.filter-tabs {
    display: flex;
    background: white;
    border-radius: 12px;
    padding: 4px;
    margin-bottom: 20px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.filter-tab {
    flex: 1;
    padding: 10px;
    text-align: center;
    border-radius: 8px;
    background: none;
    border: none;
    color: #7f8c8d;
    font-size: 14px;
    cursor: pointer;
    transition: all 0.3s ease;
}

.filter-tab.active {
    background: linear-gradient(45deg, #FF6B6B, #FF8E53);
    color: white;
    box-shadow: 0 2px 8px rgba(255, 107, 107, 0.3);
}

.action-button {
    background: linear-gradient(45deg, #4ecdc4, #44a08d);
    color: white;
    border: none;
    padding: 6px 12px;
    border-radius: 15px;
    font-size: 12px;
    cursor: pointer;
    margin-top: 5px;
}

.action-button:hover {
    transform: translateY(-1px);
    box-shadow: 0 2px 8px rgba(76, 205, 196, 0.4);
}
{% endblock %}

{% block content %}
<button class="back-button" onclick="history.back()">â†</button>

<div class="fade-in">
    <div class="card">
        <h2 class="text-center mb-4">ğŸ† æˆ‘çš„ä¸­å¥–è®°å½•</h2>
        
        <!-- ç­›é€‰æ ‡ç­¾ -->
        <div class="filter-tabs">
            <button class="filter-tab active" data-status="all">å…¨éƒ¨</button>
            <button class="filter-tab" data-status="winning">å·²ä¸­å¥–</button>
            <button class="filter-tab" data-status="sent">å·²å‘å¥–</button>
            <button class="filter-tab" data-status="expired">å·²è¿‡æœŸ</button>
        </div>
        
        <!-- åŠ è½½çŠ¶æ€ -->
        <div class="loading-state" id="loadingState">
            <div class="loading-spinner"></div>
            <div>æ­£åœ¨åŠ è½½ä¸­å¥–è®°å½•...</div>
        </div>
        
        <!-- è®°å½•åˆ—è¡¨ -->
        <div id="recordsList">
            <!-- è®°å½•å°†é€šè¿‡JavaScriptåŠ¨æ€åŠ è½½ -->
        </div>
        
        <!-- ç©ºçŠ¶æ€ -->
        <div class="empty-state" id="emptyState" style="display: none;">
            <div class="empty-icon">ğŸ²</div>
            <div class="empty-title">æš‚æ— ä¸­å¥–è®°å½•</div>
            <div class="empty-desc">å¿«å»å‚ä¸æŠ½å¥–æ´»åŠ¨å§ï¼</div>
            <button class="btn btn-primary" onclick="history.back()">è¿”å›æŠ½å¥–</button>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
const activityId = new URLSearchParams(window.location.search).get('activity_id');
let allRecords = [];
let currentFilter = 'all';

// é¡µé¢åˆå§‹åŒ–
document.addEventListener('DOMContentLoaded', function() {
    loadRecords();
    setupFilterTabs();
});

// åŠ è½½ä¸­å¥–è®°å½•
async function loadRecords() {
    const loadingState = document.getElementById('loadingState');
    const recordsList = document.getElementById('recordsList');
    const emptyState = document.getElementById('emptyState');
    
    loadingState.style.display = 'block';
    recordsList.innerHTML = '';
    emptyState.style.display = 'none';
    
    try {
        const response = await fetch('/json-rpc', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                jsonrpc: '2.0',
                method: 'GetUserLotteryChanceList',
                params: activityId ? {
                    activityId: activityId
                } : {},
                id: 1
            })
        });
        
        const data = await response.json();
        
        if (data.result && data.result.chances) {
            allRecords = data.result.chances;
            renderRecords();
        } else {
            showEmptyState();
        }
    } catch (error) {
        console.error('åŠ è½½ä¸­å¥–è®°å½•å¤±è´¥:', error);
        LotteryUtils.showToast('è·å–è®°å½•å¤±è´¥', 'error');
        showEmptyState();
    } finally {
        loadingState.style.display = 'none';
    }
}

// æ¸²æŸ“è®°å½•åˆ—è¡¨
function renderRecords() {
    const recordsList = document.getElementById('recordsList');
    const emptyState = document.getElementById('emptyState');
    
    // æ ¹æ®å½“å‰ç­›é€‰æ¡ä»¶è¿‡æ»¤è®°å½•
    let filteredRecords = allRecords;
    if (currentFilter !== 'all') {
        filteredRecords = allRecords.filter(record => record.status === currentFilter);
    }
    
    if (filteredRecords.length === 0) {
        recordsList.innerHTML = '';
        emptyState.style.display = 'block';
        return;
    }
    
    emptyState.style.display = 'none';
    recordsList.innerHTML = '';
    
    filteredRecords.forEach(record => {
        const item = document.createElement('div');
        item.className = 'record-item';
        
        const prize = record.prize;
        const statusText = getStatusText(record.status);
        const statusClass = getStatusClass(record.status);
        
        item.innerHTML = `
            ${prize && prize.picture ? 
                `<img src="${prize.picture}" alt="${prize.name}" class="record-prize-image">` : 
                '<div class="record-prize-image" style="background: #f8f9fa; display: flex; align-items: center; justify-content: center; font-size: 20px;">ğŸ</div>'
            }
            <div class="record-info">
                <div class="record-prize-name">${prize ? prize.name : 'æœªä¸­å¥–'}</div>
                <div class="record-time">${LotteryUtils.formatTime(record.useTime || record.createTime)}</div>
                <span class="record-status ${statusClass}">${statusText}</span>
                ${record.status === 'winning' && prize && prize.needConsignee ? 
                    `<button class="action-button" onclick="fillAddress('${record.id}')">å¡«å†™åœ°å€</button>` : 
                    ''
                }
            </div>
        `;
        
        recordsList.appendChild(item);
    });
}

// æ˜¾ç¤ºç©ºçŠ¶æ€
function showEmptyState() {
    document.getElementById('recordsList').innerHTML = '';
    document.getElementById('emptyState').style.display = 'block';
}

// è·å–çŠ¶æ€æ–‡æœ¬
function getStatusText(status) {
    const statusMap = {
        'init': 'æœªä½¿ç”¨',
        'winning': 'å·²ä¸­å¥–',
        'reviewed': 'å·²å®¡æ ¸',
        'sent': 'å·²å‘å¥–',
        'expired': 'å·²è¿‡æœŸ'
    };
    return statusMap[status] || 'æœªçŸ¥çŠ¶æ€';
}

// è·å–çŠ¶æ€æ ·å¼ç±»
function getStatusClass(status) {
    const classMap = {
        'init': 'status-init',
        'winning': 'status-winning',
        'reviewed': 'status-reviewed',
        'sent': 'status-sent',
        'expired': 'status-expired'
    };
    return classMap[status] || '';
}

// è®¾ç½®ç­›é€‰æ ‡ç­¾
function setupFilterTabs() {
    const tabs = document.querySelectorAll('.filter-tab');
    tabs.forEach(tab => {
        tab.addEventListener('click', function() {
            // ç§»é™¤æ‰€æœ‰æ´»è·ƒçŠ¶æ€
            tabs.forEach(t => t.classList.remove('active'));
            // æ·»åŠ å½“å‰æ´»è·ƒçŠ¶æ€
            this.classList.add('active');
            
            // æ›´æ–°ç­›é€‰æ¡ä»¶
            currentFilter = this.dataset.status;
            renderRecords();
        });
    });
}

// å¡«å†™æ”¶è´§åœ°å€
function fillAddress(chanceId) {
    const addressUrl = `/h5/lottery/address?chance_id=${chanceId}`;
    window.location.href = addressUrl;
}
{% endblock %} 